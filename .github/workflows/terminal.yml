name: Remote PowerShell Terminal

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'PowerShell command to execute'
        required: true
        type: string
      scc_token:
        description: 'Access token for Security & Compliance Center'
        required: false
        type: string

jobs:
  execute:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PowerShell Modules
        shell: pwsh
        run: |
          Write-Host "Checking for ExchangeOnlineManagement module..."
          $module = Get-Module -ListAvailable -Name ExchangeOnlineManagement
          
          if (-not $module) {
              Write-Host "Installing NuGet provider..."
              Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser
              
              Write-Host "Setting PSGallery as trusted..."
              Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
              
              Write-Host "Installing ExchangeOnlineManagement module..."
              Install-Module -Name ExchangeOnlineManagement -Repository PSGallery -Force -AllowClobber -Scope CurrentUser -SkipPublisherCheck
              
              Write-Host "Module installed successfully."
          } else {
              Write-Host "ExchangeOnlineManagement module already available."
          }
          
          Write-Host "Importing module..."
          Import-Module ExchangeOnlineManagement -Force

      - name: Run PowerShell Command
        shell: pwsh
        env:
          INPUT_COMMAND: ${{ github.event.inputs.command }}
          INPUT_TOKEN: ${{ github.event.inputs.scc_token }}
        run: |
          $command = $env:INPUT_COMMAND
          $sccToken = $env:INPUT_TOKEN
          
          if ($sccToken) {
              Write-Host "Authenticating to Purview (SCC) using provided token..."
              try {
                  Connect-IPPSSession -AccessToken $sccToken -ErrorAction Stop
                  Write-Host "Connected to Security & Compliance Center."
              } catch {
                  Write-Error "Failed to connect to SCC: $($_.Exception.Message)"
                  exit 1
              }
          }
          
          Write-Host "Executing command..."
          $ErrorActionPreference = 'Continue'
          try {
              Invoke-Expression $command | Out-String -Width 160
          } catch {
              Write-Error $_
              exit 1
          } finally {
              Write-Host "---END_OF_COMMAND---"
          }
